name: Auto Merge External PR

on:
  pull_request_target: # ì™¸ë¶€ í¬í¬ PRë„ ë©”ì¸ ë ˆí¬ ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  validate-and-merge-external:
    runs-on: ubuntu-latest
    # ì™¸ë¶€ í¬í¬ì—ì„œ ì˜¨ PRë§Œ ì²˜ë¦¬
    if: github.event.pull_request.head.repo.full_name != github.repository
    permissions:
      contents: write
      pull-requests: write
      checks: read
      actions: read
      issues: write
      repository-projects: read
      statuses: read

    steps:
      - name: Checkout base repository (ì•ˆì „í•œ ì²´í¬ì•„ì›ƒ)
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          # ì£¼ì˜: ì™¸ë¶€ PRì˜ ì½”ë“œê°€ ì•„ë‹Œ ë©”ì¸ ë ˆí¬ì˜ ì½”ë“œë¥¼ ì²´í¬ì•„ì›ƒ

      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Security check - ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ í™•ì¸
        run: |
          # PRì˜ ë³€ê²½ì‚¬í•­ì„ GitHub APIë¡œ ê°€ì ¸ì™€ì„œ í™•ì¸ (ë” ì•ˆì „í•œ ë°©ë²•)
          echo "PR ë²ˆí˜¸: ${{ github.event.number }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

          # GitHub APIë¥¼ í†µí•´ PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (rate limit ëŒ€ì‘)
          HTTP_STATUS=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files" \
               -o api_response.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            jq -r '.[].filename' api_response.json > pr_changed_files.txt
            echo "âœ… APIë¡œ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ"
          else
            echo "âŒ GitHub API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP: $HTTP_STATUS)"
            echo "Rate limit ë˜ëŠ” ê¶Œí•œ ë¬¸ì œ ê°€ëŠ¥ì„±"
            exit 1
          fi

          echo "PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤:"
          cat pr_changed_files.txt

          # ë³´ì•ˆ ê²€ì‚¬: .github/workflows ë””ë ‰í† ë¦¬ ë³€ê²½ ì‹œ ì¤‘ë‹¨
          WORKFLOW_CHANGES=$(cat pr_changed_files.txt | grep "^\.github/workflows/" || echo "")
          if [ -n "$WORKFLOW_CHANGES" ]; then
            echo "âŒ ë³´ì•ˆ ìœ„í—˜: ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì´ ê°ì§€ë¨"
            echo "ë³€ê²½ëœ ì›Œí¬í”Œë¡œìš° íŒŒì¼ë“¤: $WORKFLOW_CHANGES"
            echo "ì™¸ë¶€ PRì—ì„œ ì›Œí¬í”Œë¡œìš° ë³€ê²½ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi

          # ê¸°íƒ€ ë¯¼ê°í•œ íŒŒì¼ë“¤ ì²´í¬
          SENSITIVE_CHANGES=$(cat pr_changed_files.txt | grep -E "^\.github/(scripts/|CODEOWNERS|.*\.yml$|.*\.yaml$)" | grep -v "^\.github/workflows/" || echo "")
          if [ -n "$SENSITIVE_CHANGES" ]; then
            echo "âŒ ë³´ì•ˆ ìœ„í—˜: ë¯¼ê°í•œ íŒŒì¼ ë³€ê²½ì´ ê°ì§€ë¨"
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $SENSITIVE_CHANGES"
            echo "ì™¸ë¶€ PRì—ì„œ .github ë””ë ‰í† ë¦¬ íŒŒì¼ ë³€ê²½ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
            exit 1
          fi

      - name: Get PR author and map to folder
        id: pr-info
        run: |
          GITHUB_ID="${{ github.event.pull_request.user.login }}"
          echo "GitHub ID: $GITHUB_ID"

          # ë§¤í•‘ íŒŒì¼ì—ì„œ í´ë”ëª… ì°¾ê¸°
          FOLDER_NAME=""
          if [ -f ".github/user-mapping.yml" ]; then
            echo "ğŸ“ ë§¤í•‘ íŒŒì¼ ì¡´ì¬ í™•ì¸ë¨"
            
            # YAML íŒŒì¼ì—ì„œ ì •í™•í•œ ë§¤í•‘ ì°¾ê¸° (ê°œì„ ëœ íŒŒì‹±)
            MAPPING_LINE=$(grep "^$GITHUB_ID:" .github/user-mapping.yml | head -1 || echo "")
            if [ -n "$MAPPING_LINE" ]; then
              # "key: "value"" í˜•ì‹ì—ì„œ value ì¶”ì¶œ
              FOLDER_NAME=$(echo "$MAPPING_LINE" | cut -d'"' -f2)
              if [ -n "$FOLDER_NAME" ]; then
                echo "âœ… ë§¤í•‘ ë°œê²¬: $GITHUB_ID -> $FOLDER_NAME"
              else
                echo "âš ï¸ ë§¤í•‘ íŒŒì‹± ì‹¤íŒ¨: $MAPPING_LINE"
                FOLDER_NAME=""
              fi
            else
              echo "âŒ ë§¤í•‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: $GITHUB_ID"
              echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë§¤í•‘ë“¤:"
              grep "^[^#].*:" .github/user-mapping.yml | head -5
            fi
          else
            echo "âŒ ë§¤í•‘ íŒŒì¼ì´ ì—†ìŒ: .github/user-mapping.yml"
          fi

          echo "github_id=$GITHUB_ID" >> $GITHUB_OUTPUT
          echo "folder_name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "PR ì‘ì„±ì: $GITHUB_ID (í´ë”: $FOLDER_NAME)"

      - name: Get changed files
        id: files
        run: |
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ì„ ì´ë¯¸ ê°€ì ¸ì™”ìœ¼ë¯€ë¡œ ì¬ì‚¬ìš©
          if [ -f pr_changed_files.txt ]; then
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
            cat pr_changed_files.txt
            CHANGED_FILES=$(cat pr_changed_files.txt | tr '\n' ' ')
          else
            # API í˜¸ì¶œì´ ì‹¤íŒ¨í•œ ê²½ìš° fallback
            echo "APIì—ì„œ íŒŒì¼ ëª©ë¡ì„ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. Gitìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤."
            git diff --name-only main..HEAD > changed_files.txt
            echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
            cat changed_files.txt
            CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          fi

          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Validate changes
        id: validate
        run: |
          GITHUB_ID="${{ steps.pr-info.outputs.github_id }}"
          FOLDER_NAME="${{ steps.pr-info.outputs.folder_name }}"
          CHANGED_FILES="${{ steps.files.outputs.changed_files }}"

          echo "ğŸ” ì™¸ë¶€ PR ê²€ì¦ ì‹œì‘..."
          echo "GitHub ID: $GITHUB_ID"
          echo "í—ˆìš©ëœ í´ë”ëª…: $FOLDER_NAME"
          echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"

          # ê²€ì¦ ê·œì¹™ (ë” ì—„ê²©í•˜ê²Œ)
          VALID=true
          REASON=""

          # 0. ë§¤í•‘ëœ í´ë”ëª…ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$FOLDER_NAME" ]; then
            VALID=false
            REASON="GitHub ID ($GITHUB_ID)ì— ëŒ€í•œ í´ë” ë§¤í•‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
          fi

          # 1. ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$CHANGED_FILES" ] && [ "$VALID" = "true" ]; then
            VALID=false
            REASON="ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

          # 2. ê° ë³€ê²½ëœ íŒŒì¼ì´ í•´ë‹¹ ì‚¬ìš©ì í´ë” ë‚´ì— ìˆëŠ”ì§€ í™•ì¸ (ë” ì—„ê²©)
          if [ "$VALID" = "true" ]; then
            for file in $CHANGED_FILES; do
              echo "ê²€ì‚¬ ì¤‘ì¸ íŒŒì¼: $file"
              
              # ë£¨íŠ¸ íŒŒì¼ë“¤ì€ ì ˆëŒ€ í—ˆìš©í•˜ì§€ ì•ŠìŒ
              if [[ "$file" == *.md ]] && [[ "$file" != */* ]]; then
                VALID=false
                REASON="ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ($file) ìˆ˜ì •ì€ ì™¸ë¶€ PRì—ì„œ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                break
              fi
              
              # .github ë””ë ‰í† ë¦¬ëŠ” ì ˆëŒ€ í—ˆìš©í•˜ì§€ ì•ŠìŒ
              if [[ "$file" == .github/* ]]; then
                VALID=false
                REASON=".github ë””ë ‰í† ë¦¬ ìˆ˜ì •ì€ ì™¸ë¶€ PRì—ì„œ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                break
              fi
              
              # ë‹¤ë¥¸ ì„¤ì • íŒŒì¼ë“¤ë„ ì°¨ë‹¨
              if [[ "$file" == .gitignore ]] || [[ "$file" == LICENSE ]] || [[ "$file" == .* ]]; then
                VALID=false
                REASON="ì„¤ì • íŒŒì¼ ($file) ìˆ˜ì •ì€ ì™¸ë¶€ PRì—ì„œ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                break
              fi
              
              # ì‚¬ìš©ì í´ë” ë‚´ íŒŒì¼ì¸ì§€ í™•ì¸
              if [[ "$file" == */* ]]; then
                FILE_FOLDER=$(echo "$file" | cut -d'/' -f1)
                
                # í´ë”ëª…ì´ ë§¤í•‘ëœ í´ë”ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                if [ "$FILE_FOLDER" != "$FOLDER_NAME" ]; then
                  VALID=false
                  REASON="ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í´ë” ($FILE_FOLDER) ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³¸ì¸ì˜ í´ë” ($FOLDER_NAME)ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤."
                  break
                fi
                
                # í—ˆìš©ë˜ëŠ” íŒŒì¼ í˜•ì‹ì¸ì§€ í™•ì¸ (ë” ì—„ê²©)
                if [[ "$file" == *README.md ]] || [[ "$file" == *.py ]] || [[ "$file" == *.cpp ]] || [[ "$file" == *.java ]] || [[ "$file" == *.js ]] || [[ "$file" == *.c ]] || [[ "$file" == *.rs ]] || [[ "$file" == *.py3 ]]; then
                  echo "âœ… í—ˆìš©ë˜ëŠ” íŒŒì¼: $file"
                else
                  VALID=false
                  REASON="í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: $file"
                  break
                fi
              else
                VALID=false
                REASON="í´ë” êµ¬ì¡°ë¥¼ ë”°ë¥´ì§€ ì•ŠëŠ” íŒŒì¼ì…ë‹ˆë‹¤: $file"
                break
              fi
            done
          fi

          # 3. ìµœì†Œ í•˜ë‚˜ì˜ ë¬¸ì œ í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ "$VALID" = "true" ]; then
            PROBLEM_FOLDERS=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep "^$FOLDER_NAME/[0-9]" | head -1)
            if [ -z "$PROBLEM_FOLDERS" ]; then
              VALID=false
              REASON="ë¬¸ì œ ë²ˆí˜¸ í´ë”ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì˜ˆ: $FOLDER_NAME/1000/)"
            fi
          fi

          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

          if [ "$VALID" = "true" ]; then
            echo "âœ… ì™¸ë¶€ PR ê²€ì¦ í†µê³¼!"
          else
            echo "âŒ ì™¸ë¶€ PR ê²€ì¦ ì‹¤íŒ¨: $REASON"
          fi

      - name: Comment on PR if validation fails
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reason = '${{ steps.validate.outputs.reason }}';
            const githubId = '${{ steps.pr-info.outputs.github_id }}';
            const folderName = '${{ steps.pr-info.outputs.folder_name }}';

            const comment = `âŒ **ì™¸ë¶€ PR ìë™ ê²€ì¦ ì‹¤íŒ¨**

            **ì‹¤íŒ¨ ì‚¬ìœ :** ${reason}

            **ì™¸ë¶€ PR ê·œì¹™ (ë” ì—„ê²©):**
            1. ë³¸ì¸ì˜ í´ë”(\`${folderName || githubId}/\`)ì— ìˆëŠ” ì½”ë“œ íŒŒì¼ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
            2. ë¬¸ì œ ë²ˆí˜¸ í´ë”(ì˜ˆ: \`${folderName || githubId}/1000/\`)ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
            3. ë£¨íŠ¸ íŒŒì¼, ì„¤ì • íŒŒì¼, .github í´ë” ìˆ˜ì •ì€ ì ˆëŒ€ ë¶ˆê°€í•©ë‹ˆë‹¤
            4. í—ˆìš©ë˜ëŠ” íŒŒì¼ í˜•ì‹: .py, .cpp, .java, .js, .c, .rs, .py3, README.md

            **GitHub IDì™€ í´ë” ë§¤í•‘:**
            - GitHub ID: ${githubId}
            - í—ˆìš©ëœ í´ë”: ${folderName || 'ë§¤í•‘ë˜ì§€ ì•ŠìŒ'}

            **ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!** ğŸ”„`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR if validation passes
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const githubId = '${{ steps.pr-info.outputs.github_id }}';
            const folderName = '${{ steps.pr-info.outputs.folder_name }}';
            const changedFiles = '${{ steps.files.outputs.changed_files }}';

            const comment = `âœ… **ì™¸ë¶€ PR ìë™ ê²€ì¦ í†µê³¼!**

            **ê²€ì¦ëœ ë‚´ìš©:**
            - GitHub ID: ${githubId}
            - í—ˆìš©ëœ í´ë”: ${folderName}
            - ìˆ˜ì •ëœ íŒŒì¼ë“¤: ${changedFiles}

            ëª¨ë“  ë³´ì•ˆ ê·œì¹™ì„ ë§Œì¡±í•˜ì—¬ ìë™ìœ¼ë¡œ ë¨¸ì§€ë©ë‹ˆë‹¤. ğŸ‰

            âš ï¸ **ë³´ì•ˆ ì•Œë¦¼**: ì´ëŠ” ì™¸ë¶€ ê¸°ì—¬ìì˜ PRì´ë¯€ë¡œ ì¶”ê°€ ë³´ì•ˆ ê²€ì¦ì„ ê±°ì³¤ìŠµë‹ˆë‹¤.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Auto approve PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'ğŸ¤– ìë™ ìŠ¹ì¸: ëª¨ë“  ë³´ì•ˆ ê²€ì¦ ê·œì¹™ì„ ë§Œì¡±í•©ë‹ˆë‹¤! (ì™¸ë¶€ PR ê²€ì¦ ì™„ë£Œ)'
            });

      - name: Auto merge PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                commit_title: `Auto-merge (External): ${context.payload.pull_request.title}`,
                commit_message: `ì™¸ë¶€ PR ìë™ ë¨¸ì§€ë¨ - ${{ steps.pr-info.outputs.github_id }}(${{ steps.pr-info.outputs.folder_name }})ì˜ ë¬¸ì œ í’€ì´`,
                merge_method: 'squash'
              });
              console.log('âœ… ì™¸ë¶€ PRì´ ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
              console.log('âŒ ì™¸ë¶€ PR ë¨¸ì§€ ì‹¤íŒ¨:', error.message);
              console.log('ì—ëŸ¬ ìƒì„¸:', error);
              
              // ë¨¸ì§€ ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **ì™¸ë¶€ PR ìë™ ë¨¸ì§€ ì‹¤íŒ¨**\n\n**ì˜¤ë¥˜:** ${error.message}\n\n**ê°€ëŠ¥í•œ ì›ì¸:**\n- ì¶©ëŒ(conflict)ì´ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n- ë¸Œëœì¹˜ ë³´í˜¸ ê·œì¹™ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n- í•„ìˆ˜ ì²´í¬ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n\n**í•´ê²°ë°©ë²•:** ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë¨¸ì§€í•˜ê±°ë‚˜ ì¶©ëŒì„ í•´ê²°í•´ì£¼ì„¸ìš”.`
              });
              throw error;
            }
