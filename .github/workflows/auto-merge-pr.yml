name: Auto Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Get PR author
        id: pr-info
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          echo "pr_author=$PR_AUTHOR" >> $GITHUB_OUTPUT
          echo "PR ì‘ì„±ì: $PR_AUTHOR"

      - name: Get changed files
        id: changed-files
        run: |
          # PRì—ì„œ ë³€ê²½ëœ íŒŒì¼ë“¤ ê°€ì ¸ì˜¤ê¸°
          git diff --name-only origin/main..HEAD > changed_files.txt
          echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
          cat changed_files.txt

          # ë³€ê²½ëœ íŒŒì¼ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Validate changes
        id: validate
        run: |
          PR_AUTHOR="${{ steps.pr-info.outputs.pr_author }}"
          CHANGED_FILES="${{ steps.changed-files.outputs.changed_files }}"

          echo "ğŸ” PR ê²€ì¦ ì‹œì‘..."
          echo "PR ì‘ì„±ì: $PR_AUTHOR"
          echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"

          # ê²€ì¦ ê·œì¹™
          VALID=true
          REASON=""

          # 1. ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$CHANGED_FILES" ]; then
            VALID=false
            REASON="ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

          # 2. ê° ë³€ê²½ëœ íŒŒì¼ì´ í•´ë‹¹ ì‚¬ìš©ì í´ë” ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
          for file in $CHANGED_FILES; do
            echo "ê²€ì‚¬ ì¤‘ì¸ íŒŒì¼: $file"
            
            # ë£¨íŠ¸ íŒŒì¼ë“¤ì€ í—ˆìš©í•˜ì§€ ì•ŠìŒ (README.md, .github ë“±)
            if [[ "$file" == *.md ]] && [[ "$file" != */* ]]; then
              VALID=false
              REASON="ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ($file) ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              break
            fi
            
            if [[ "$file" == .github/* ]]; then
              VALID=false
              REASON=".github ë””ë ‰í† ë¦¬ ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
              break
            fi
            
            # ì‚¬ìš©ì í´ë” ë‚´ íŒŒì¼ì¸ì§€ í™•ì¸
            if [[ "$file" == */* ]]; then
              FOLDER_NAME=$(echo "$file" | cut -d'/' -f1)
              
              # í´ë”ëª…ì´ PR ì‘ì„±ìì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
              if [ "$FOLDER_NAME" != "$PR_AUTHOR" ]; then
                VALID=false
                REASON="ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í´ë” ($FOLDER_NAME) ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³¸ì¸ì˜ í´ë” ($PR_AUTHOR)ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤."
                break
              fi
              
              # í—ˆìš©ë˜ëŠ” íŒŒì¼ í˜•ì‹ì¸ì§€ í™•ì¸ (ì„ íƒì )
              if [[ "$file" == *README.md ]] || [[ "$file" == *.py ]] || [[ "$file" == *.cpp ]] || [[ "$file" == *.java ]] || [[ "$file" == *.js ]] || [[ "$file" == *.c ]]; then
                echo "âœ… í—ˆìš©ë˜ëŠ” íŒŒì¼: $file"
              else
                echo "âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” íŒŒì¼ í˜•ì‹ì´ì§€ë§Œ í—ˆìš©: $file"
              fi
            else
              VALID=false
              REASON="í´ë” êµ¬ì¡°ë¥¼ ë”°ë¥´ì§€ ì•ŠëŠ” íŒŒì¼ì…ë‹ˆë‹¤: $file"
              break
            fi
          done

          # 3. ìµœì†Œ í•˜ë‚˜ì˜ ë¬¸ì œ í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
          PROBLEM_FOLDERS=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep "^$PR_AUTHOR/[0-9]" | head -1)
          if [ -z "$PROBLEM_FOLDERS" ] && [ "$VALID" = "true" ]; then
            VALID=false
            REASON="ë¬¸ì œ ë²ˆí˜¸ í´ë”ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì˜ˆ: $PR_AUTHOR/1000/)"
          fi

          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

          if [ "$VALID" = "true" ]; then
            echo "âœ… PR ê²€ì¦ í†µê³¼!"
          else
            echo "âŒ PR ê²€ì¦ ì‹¤íŒ¨: $REASON"
          fi

      - name: Comment on PR if validation fails
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const reason = '${{ steps.validate.outputs.reason }}';
            const prAuthor = '${{ steps.pr-info.outputs.pr_author }}';

            const comment = `âŒ **PR ìë™ ê²€ì¦ ì‹¤íŒ¨**

            **ì‹¤íŒ¨ ì‚¬ìœ :** ${reason}

            **ê·œì¹™:**
            1. ë³¸ì¸ì˜ í´ë”(\`${prAuthor}/\`)ì— ìˆëŠ” íŒŒì¼ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
            2. ë¬¸ì œ ë²ˆí˜¸ í´ë”(ì˜ˆ: \`${prAuthor}/1000/\`)ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
            3. ë£¨íŠ¸ íŒŒì¼ì´ë‚˜ ë‹¤ë¥¸ ì‚¬ìš©ì í´ë” ìˆ˜ì •ì€ ë¶ˆê°€í•©ë‹ˆë‹¤
            4. \`.github\` í´ë” ìˆ˜ì •ì€ ë¶ˆê°€í•©ë‹ˆë‹¤

            **ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!** ğŸ”„`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR if validation passes
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prAuthor = '${{ steps.pr-info.outputs.pr_author }}';
            const changedFiles = '${{ steps.changed-files.outputs.changed_files }}';

            const comment = `âœ… **PR ìë™ ê²€ì¦ í†µê³¼!**

            **ê²€ì¦ëœ ë‚´ìš©:**
            - ì‘ì„±ì: ${prAuthor}
            - ìˆ˜ì •ëœ íŒŒì¼ë“¤: ${changedFiles}

            ëª¨ë“  ê·œì¹™ì„ ë§Œì¡±í•˜ì—¬ ìë™ìœ¼ë¡œ ë¨¸ì§€ë©ë‹ˆë‹¤. ğŸ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Auto approve PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'ğŸ¤– ìë™ ìŠ¹ì¸: ëª¨ë“  ê²€ì¦ ê·œì¹™ì„ ë§Œì¡±í•©ë‹ˆë‹¤!'
            });

      - name: Auto merge PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
                commit_message: `ìë™ ë¨¸ì§€ë¨ - ${{ steps.pr-info.outputs.pr_author }}ì˜ ë¬¸ì œ í’€ì´`,
                merge_method: 'squash'
              });
              console.log('âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
              console.log('âŒ ë¨¸ì§€ ì‹¤íŒ¨:', error.message);
              
              // ë¨¸ì§€ ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **ìë™ ë¨¸ì§€ ì‹¤íŒ¨**\n\nì˜¤ë¥˜: ${error.message}\n\nìˆ˜ë™ìœ¼ë¡œ ë¨¸ì§€í•´ì£¼ì„¸ìš”.`
              });
            }

      - name: Trigger README update
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // README ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±°
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'update-readme.yml',
              ref: 'main'
            });
            console.log('âœ… README ì—…ë°ì´íŠ¸ ì›Œí¬í”Œë¡œìš°ê°€ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤!');
