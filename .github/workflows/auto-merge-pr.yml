name: Auto Merge PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main]

jobs:
  validate-and-merge:
    runs-on: ubuntu-latest
    # í¬í¬ëœ PRì€ ì œì™¸ (ë³´ì•ˆìƒ ì´ìœ )
    if: github.event.pull_request.head.repo.full_name == github.repository
    permissions:
      contents: write
      pull-requests: write
      checks: read
      actions: read
      issues: write
      repository-projects: read
      statuses: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Install jq for JSON parsing
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Get changed files via GitHub API
        id: files
        run: |
          echo "PR ë²ˆí˜¸: ${{ github.event.number }}"
          echo "Base SHA: ${{ github.event.pull_request.base.sha }}"
          echo "Head SHA: ${{ github.event.pull_request.head.sha }}"

          # GitHub APIë¥¼ í†µí•´ PRì˜ ë³€ê²½ëœ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° (ë‚´ë¶€/ì™¸ë¶€ PR ì¼ê´€ì„± í™•ë³´)
          HTTP_STATUS=$(curl -s -w "%{http_code}" -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github.v3+json" \
               "https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.number }}/files" \
               -o api_response.json)

          if [ "$HTTP_STATUS" -eq 200 ]; then
            jq -r '.[].filename' api_response.json > changed_files.txt
            echo "âœ… APIë¡œ íŒŒì¼ ëª©ë¡ ê°€ì ¸ì˜¤ê¸° ì„±ê³µ"
          else
            echo "âŒ GitHub API í˜¸ì¶œ ì‹¤íŒ¨ (HTTP: $HTTP_STATUS), Git ë°©ì‹ìœ¼ë¡œ fallback"
            # API ì‹¤íŒ¨ ì‹œ Git ë°©ì‹ìœ¼ë¡œ fallback
            git diff --name-only ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }} > changed_files.txt
          fi

          echo "ë³€ê²½ëœ íŒŒì¼ë“¤:"
          cat changed_files.txt

          # ë³€ê²½ëœ íŒŒì¼ë“¤ì„ í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
          CHANGED_FILES=$(cat changed_files.txt | tr '\n' ' ')
          echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT

      - name: Get PR author and map to folder
        id: pr-info
        run: |
          GITHUB_ID="${{ github.event.pull_request.user.login }}"
          echo "GitHub ID: $GITHUB_ID"

          # ë§¤í•‘ íŒŒì¼ì—ì„œ í´ë”ëª… ì°¾ê¸°
          FOLDER_NAME=""
          if [ -f ".github/user-mapping.yml" ]; then
            echo "ğŸ“ ë§¤í•‘ íŒŒì¼ ì¡´ì¬ í™•ì¸ë¨"
            
            # YAML íŒŒì¼ì—ì„œ ì •í™•í•œ ë§¤í•‘ ì°¾ê¸° (ê°œì„ ëœ íŒŒì‹±)
            MAPPING_LINE=$(grep "^$GITHUB_ID:" .github/user-mapping.yml | head -1 || echo "")
            if [ -n "$MAPPING_LINE" ]; then
              # "key: "value"" í˜•ì‹ì—ì„œ value ì¶”ì¶œ
              FOLDER_NAME=$(echo "$MAPPING_LINE" | cut -d'"' -f2)
              if [ -n "$FOLDER_NAME" ]; then
                echo "âœ… ë§¤í•‘ ë°œê²¬: $GITHUB_ID -> $FOLDER_NAME"
              else
                echo "âš ï¸ ë§¤í•‘ íŒŒì‹± ì‹¤íŒ¨: $MAPPING_LINE"
                FOLDER_NAME=""
              fi
            else
              echo "âŒ ë§¤í•‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ: $GITHUB_ID"
              echo "ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ ë§¤í•‘ë“¤:"
              grep "^[^#].*:" .github/user-mapping.yml | head -5
            fi
          else
            echo "âŒ ë§¤í•‘ íŒŒì¼ì´ ì—†ìŒ: .github/user-mapping.yml"
          fi

          echo "github_id=$GITHUB_ID" >> $GITHUB_OUTPUT
          echo "folder_name=$FOLDER_NAME" >> $GITHUB_OUTPUT
          echo "PR ì‘ì„±ì: $GITHUB_ID (í´ë”: $FOLDER_NAME)"

      - name: Validate changes
        id: validate
        run: |
          GITHUB_ID="${{ steps.pr-info.outputs.github_id }}"
          FOLDER_NAME="${{ steps.pr-info.outputs.folder_name }}"
          CHANGED_FILES="${{ steps.files.outputs.changed_files }}"

          echo "ğŸ” PR ê²€ì¦ ì‹œì‘..."
          echo "GitHub ID: $GITHUB_ID"
          echo "í—ˆìš©ëœ í´ë”ëª…: $FOLDER_NAME"
          echo "ë³€ê²½ëœ íŒŒì¼ë“¤: $CHANGED_FILES"

          # ê²€ì¦ ê·œì¹™
          VALID=true
          REASON=""

          # 0. ë§¤í•‘ëœ í´ë”ëª…ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$FOLDER_NAME" ]; then
            VALID=false
            REASON="GitHub ID ($GITHUB_ID)ì— ëŒ€í•œ í´ë” ë§¤í•‘ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”."
          fi

          # 1. ë³€ê²½ëœ íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
          if [ -z "$CHANGED_FILES" ] && [ "$VALID" = "true" ]; then
            VALID=false
            REASON="ë³€ê²½ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi

          # 2. ê° ë³€ê²½ëœ íŒŒì¼ì´ í•´ë‹¹ ì‚¬ìš©ì í´ë” ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
          if [ "$VALID" = "true" ]; then
            for file in $CHANGED_FILES; do
              echo "ê²€ì‚¬ ì¤‘ì¸ íŒŒì¼: $file"
              
              # ë£¨íŠ¸ íŒŒì¼ë“¤ì€ í—ˆìš©í•˜ì§€ ì•ŠìŒ (README.md, .github ë“±)
              if [[ "$file" == *.md ]] && [[ "$file" != */* ]]; then
                VALID=false
                REASON="ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì˜ íŒŒì¼ ($file) ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                break
              fi
              
              if [[ "$file" == .github/* ]]; then
                VALID=false
                REASON=".github ë””ë ‰í† ë¦¬ ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
                break
              fi
              
              # ì‚¬ìš©ì í´ë” ë‚´ íŒŒì¼ì¸ì§€ í™•ì¸
              if [[ "$file" == */* ]]; then
                FILE_FOLDER=$(echo "$file" | cut -d'/' -f1)
                
                # í´ë”ëª…ì´ ë§¤í•‘ëœ í´ë”ì™€ ì¼ì¹˜í•˜ëŠ”ì§€ í™•ì¸
                if [ "$FILE_FOLDER" != "$FOLDER_NAME" ]; then
                  VALID=false
                  REASON="ë‹¤ë¥¸ ì‚¬ìš©ìì˜ í´ë” ($FILE_FOLDER) ìˆ˜ì •ì€ í—ˆìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë³¸ì¸ì˜ í´ë” ($FOLDER_NAME)ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤."
                  break
                fi
                
                # í—ˆìš©ë˜ëŠ” íŒŒì¼ í˜•ì‹ì¸ì§€ í™•ì¸ (ì—„ê²©)
                if [[ "$file" == *README.md ]] || [[ "$file" == *.py ]] || [[ "$file" == *.cpp ]] || [[ "$file" == *.java ]] || [[ "$file" == *.js ]] || [[ "$file" == *.c ]] || [[ "$file" == *.rs ]] || [[ "$file" == *.py3 ]]; then
                  echo "âœ… í—ˆìš©ë˜ëŠ” íŒŒì¼: $file"
                else
                  VALID=false
                  REASON="í—ˆìš©ë˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤: $file (í—ˆìš©: .py, .cpp, .java, .js, .c, .rs, .py3, README.md)"
                  break
                fi
              else
                VALID=false
                REASON="í´ë” êµ¬ì¡°ë¥¼ ë”°ë¥´ì§€ ì•ŠëŠ” íŒŒì¼ì…ë‹ˆë‹¤: $file"
                break
              fi
            done
          fi

          # 3. ìµœì†Œ í•˜ë‚˜ì˜ ë¬¸ì œ í´ë”ê°€ ìˆëŠ”ì§€ í™•ì¸
          if [ "$VALID" = "true" ]; then
            PROBLEM_FOLDERS=$(echo "$CHANGED_FILES" | tr ' ' '\n' | grep "^$FOLDER_NAME/[0-9]" | head -1)
            if [ -z "$PROBLEM_FOLDERS" ]; then
              VALID=false
              REASON="ë¬¸ì œ ë²ˆí˜¸ í´ë”ê°€ í¬í•¨ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. (ì˜ˆ: $FOLDER_NAME/1000/)"
            fi
          fi

          echo "valid=$VALID" >> $GITHUB_OUTPUT
          echo "reason=$REASON" >> $GITHUB_OUTPUT

          if [ "$VALID" = "true" ]; then
            echo "âœ… PR ê²€ì¦ í†µê³¼!"
          else
            echo "âŒ PR ê²€ì¦ ì‹¤íŒ¨: $REASON"
          fi

      - name: Comment on PR if validation fails
        if: steps.validate.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const reason = '${{ steps.validate.outputs.reason }}';
            const githubId = '${{ steps.pr-info.outputs.github_id }}';
            const folderName = '${{ steps.pr-info.outputs.folder_name }}';

            const comment = `âŒ **PR ìë™ ê²€ì¦ ì‹¤íŒ¨**

            **ì‹¤íŒ¨ ì‚¬ìœ :** ${reason}

            **ê·œì¹™:**
            1. ë³¸ì¸ì˜ í´ë”(\`${folderName || githubId}/\`)ì— ìˆëŠ” íŒŒì¼ë§Œ ìˆ˜ì • ê°€ëŠ¥í•©ë‹ˆë‹¤
            2. ë¬¸ì œ ë²ˆí˜¸ í´ë”(ì˜ˆ: \`${folderName || githubId}/1000/\`)ê°€ í¬í•¨ë˜ì–´ì•¼ í•©ë‹ˆë‹¤
            3. ë£¨íŠ¸ íŒŒì¼ì´ë‚˜ ë‹¤ë¥¸ ì‚¬ìš©ì í´ë” ìˆ˜ì •ì€ ë¶ˆê°€í•©ë‹ˆë‹¤
            4. \`.github\` í´ë” ìˆ˜ì •ì€ ë¶ˆê°€í•©ë‹ˆë‹¤

            **GitHub IDì™€ í´ë” ë§¤í•‘:**
            - GitHub ID: ${githubId}
            - í—ˆìš©ëœ í´ë”: ${folderName || 'ë§¤í•‘ë˜ì§€ ì•ŠìŒ'}

            **ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”!** ğŸ”„`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Comment on PR if validation passes
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const githubId = '${{ steps.pr-info.outputs.github_id }}';
            const folderName = '${{ steps.pr-info.outputs.folder_name }}';
            const changedFiles = '${{ steps.files.outputs.changed_files }}';

            const comment = `âœ… **PR ìë™ ê²€ì¦ í†µê³¼!**

            **ê²€ì¦ëœ ë‚´ìš©:**
            - GitHub ID: ${githubId}
            - í—ˆìš©ëœ í´ë”: ${folderName}
            - ìˆ˜ì •ëœ íŒŒì¼ë“¤: ${changedFiles}

            ëª¨ë“  ê·œì¹™ì„ ë§Œì¡±í•˜ì—¬ ìë™ìœ¼ë¡œ ë¨¸ì§€ë©ë‹ˆë‹¤. ğŸ‰`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Auto approve PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: 'ğŸ¤– ìë™ ìŠ¹ì¸: ëª¨ë“  ê²€ì¦ ê·œì¹™ì„ ë§Œì¡±í•©ë‹ˆë‹¤!'
            });

      - name: Auto merge PR
        if: steps.validate.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            try {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                commit_title: `Auto-merge: ${context.payload.pull_request.title}`,
                commit_message: `ìë™ ë¨¸ì§€ë¨ - ${{ steps.pr-info.outputs.github_id }}(${{ steps.pr-info.outputs.folder_name }})ì˜ ë¬¸ì œ í’€ì´`,
                merge_method: 'squash'
              });
              console.log('âœ… PRì´ ì„±ê³µì ìœ¼ë¡œ ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
              console.log('âŒ ë¨¸ì§€ ì‹¤íŒ¨:', error.message);
              console.log('ì—ëŸ¬ ìƒì„¸:', error);
              
              // ë¨¸ì§€ ì‹¤íŒ¨ ì‹œ ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `âŒ **ìë™ ë¨¸ì§€ ì‹¤íŒ¨**\n\n**ì˜¤ë¥˜:** ${error.message}\n\n**ê°€ëŠ¥í•œ ì›ì¸:**\n- ì¶©ëŒ(conflict)ì´ ë°œìƒí–ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n- ë¸Œëœì¹˜ ë³´í˜¸ ê·œì¹™ì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n- í•„ìˆ˜ ì²´í¬ê°€ ì™„ë£Œë˜ì§€ ì•Šì•˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤\n\n**í•´ê²°ë°©ë²•:** ìˆ˜ë™ìœ¼ë¡œ ë¨¸ì§€í•˜ê±°ë‚˜ ì¶©ëŒì„ í•´ê²°í•´ì£¼ì„¸ìš”.`
              });
              throw error;
            }
